# 检测室数据分析系统需求分析

## 业务背景

### 当前问题
- 依靠 Excel 表格进行检测数据记录、统计和分析
- 多人多文件、版本不一致
- 人工汇总成本高、公式易出错
- 统计口径难统一、数据难以追溯

### 系统目标
从"Excel 手工统计"转向"系统自动统计 + 智能分析"

---

## 核心业务对象

### 1. 产品规格
- **四种产品规格**：120、142、170、213
- **关键属性**：
  - 规格代码
  - 规格名称
  - 对应原始数据有效列（13、15、18、22）
  - 扩展属性：长度、层数、密度（默认 7.25）

---

### 2. 炉号（生产批次）
- **格式**：`[产线数字][班次汉字][8位日期]-[炉号]-[卷号]-[分卷号][可选特性汉字]`
- **示例**：`1甲20251101-1-4-1脆`
- **解析字段**：
  - 产线（line_no）
  - 班次（shift）
  - 日期（prod_date）
  - 炉号（furnace_no）
  - 卷号（coil_no）
  - 分卷号（subcoil_no）
  - 特性描述（feature_suffix）

---

### 3. 原始检测数据
- **来源**：现场检测设备导出或手工录入
- **关键字段**：
  - 日期
  - 炉号
  - 宽度
  - 带材重量
  - 1～22 列检测数据

---

### 4. 中间数据表
- **结构**：按规格分表（如"11月120"、"11月142"等）
- **字段分组**：
  - 基础信息：日期、喷次、炉号
  - 磁性能：Ss、激磁功率、Ps、铁损、Hc
  - 刻痕后性能：同上
  - 物理属性：一米带材重量、带宽、带厚、密度、叠片系数
  - 外观特性：外观特征、断头数、单卷重量
  - 判定结果：磁性能判定、厚度判定、叠片系数判定
  - 花纹数据：左中右花纹的 Si、B、纹宽、纹距

---

### 5. 外观特性
- **外观特征大类**：韧性、脆边、麻点、划痕、网眼、毛边、亮线、劈裂、棱、龟裂纹
- **子类**：例如"脆"归属于"韧性"
- **等级**：严重、中等、轻微

---

### 6. 质量等级
- **A 类**：铁损和 Hc 指标均不超过 A 类阈值，且所有外观缺陷为"无"
- **B 类**：超过 A 类阈值但在 B 类范围
- **C 类/不合格**：超出 B 类范围

---

## 核心业务流程

### 流程 1：原始数据导入
```
1. 上传 Excel 文件
2. 解析表头（日期、炉号、宽度、带材重量、1～22列检测数据）
3. 炉号解析（产线、班次、日期、炉号、卷号、分卷号、特性）
4. 规格识别（根据检测列索引和宽度）
5. 数据校验（必填字段、数值范围）
6. 错误报告生成
7. 数据存储
```

---

### 流程 2：中间数据计算
```
1. 从原始数据读取
2. 计算物理属性：
   - 一米带材重量 = 带材重量 / 长度
   - 带厚 = 检测数据 / 层数
   - 带厚范围 = 最小值～最大值
   - 带厚极差 = 最大值 - 最小值
   - 平均厚度 = 原始数据平均
   - 密度 = 一米带材重量 / (带宽 * 平均厚度/10)
   - 叠片系数 = 四米带材重量 / (带宽 * 400 * 平均厚度 * 7.25 * 0.0000001)
3. 人工录入：
   - 磁性能数据
   - 外观特性
   - 断头数、单卷重量
4. 质量判定：
   - 磁性能判定
   - 厚度判定
   - 叠片系数判定
5. 数据存储
```

---

### 流程 3：统计汇总
```
1. 选择统计维度（日期、班次、规格、产线）
2. 计算指标：
   - 总检测量
   - A/B/C 类数量及占比
   - 平均铁损
   - 平均 Hc
   - 缺陷分布
3. 生成报表
4. 导出 Excel
```

---

### 流程 4：自然语言问数
```
1. 用户输入自然语言问题
2. 大模型解析意图
3. 生成结构化查询
4. 执行查询
5. 返回表格、图表、文字说明
```

---

## 用户角色

| 角色 | 职责 |
|------|------|
| **管理员** | 系统配置、产品定义、用户与权限管理 |
| **检测数据导入员** | 上传原始数据表、导入中间表 |
| **性能录入员** | 在中间表中录入/校正性能数据 |
| **外观检测员** | 录入外观缺陷、断头数等数据 |
| **质量工程师** | 查看统计汇总表、定义指标、进行数据分析 |
| **领导/管理层** | 通过报表和自然语言问数获取汇总信息 |

---

## 关键计算公式

### 1. 一米带材重量
```
一米带材重量(g) = 带材重量 / 长度(4m)
```

### 2. 带厚
```
带厚 = 检测数据列 / 层数(20)
```

### 3. 密度
```
密度(g/cm³) = 一米带材重量(g) / (带宽(mm) * (平均厚度/10))
```

### 4. 叠片系数
```
叠片系数 = 四米带材重量(g) / (带宽(mm) * 400 * 平均厚度 * 7.25 * 0.0000001)
```

### 5. 带型（自定义分离度指标）
```
IF(中间组平均值 < 两侧组平均值, 
   中间组最小值 - 两侧组最大值, 
   中间组最大值 - 两侧组最小值)
```

---

## 扩展场景

### 焊接协作臂管理
- **设备管理**：焊接协作臂的状态、参数、维护记录
- **工艺参数**：焊接电流、电压、速度、气体流量
- **质量检测**：焊缝质量、缺陷检测
- **设备联动**：与检测室数据的关联

### 小组立产线排产
- **生产计划**：订单、产品规格、数量、交期
- **产线资源**：产线、设备、人员、班次
- **排产优化**：基于检测数据的质量预测和排产调整
- **实时监控**：生产进度、质量状态、设备状态

---

## 系统架构需求

### 非功能需求
- **性能**：日均 1～2 万条数据导入，5 分钟内完成；查询 3 秒内返回
- **安全**：HTTPS、JWT 认证、RBAC 权限控制、数据加密、审计日志
- **易用性**：类 Excel 交互、错误高亮提示
- **可维护性**：分层架构、参数化配置
- **可扩展性**：支持接入更多外部系统（MES、ERP）

---

## 关键挑战

### 1. 复杂的炉号解析
- 格式复杂：`1甲20251101-1-4-1脆`
- 需要准确解析产线、班次、日期、炉号、卷号、分卷号、特性

### 2. 多维度的数据计算
- 物理属性计算（带厚、密度、叠片系数）
- 质量判定（磁性能、厚度、叠片系数）
- 统计汇总（多维度、多指标）

### 3. 人工录入与自动计算的结合
- 部分数据需要人工录入（磁性能、外观特性）
- 部分数据自动计算（物理属性、质量判定）
- 需要保证数据一致性

### 4. 灵活的统计分析
- 多维度统计（日期、班次、规格、产线）
- 自定义指标
- 自然语言问数

---

## 与 Palantir 方法论的契合点

### 1. Ontology 建模
- **Objects**：产品规格、炉号、原始检测数据、中间数据、外观特性、质量等级
- **Properties**：各对象的属性
- **Links**：对象之间的关系（如炉号 → 原始数据 → 中间数据 → 质量等级）
- **Actions**：导入数据、计算物理属性、质量判定、统计汇总

### 2. 用例驱动
- **用例 1**：提升检测数据录入效率（从 Excel 手工录入到系统自动导入）
- **用例 2**：提高统计分析准确性（从人工计算到系统自动计算）
- **用例 3**：实现多维度质量分析（从单一报表到多维度统计）
- **用例 4**：支持自然语言问数（从查看报表到智能问答）

### 3. Data + Logic + Action + Security
- **Data**：原始检测数据、中间数据、统计数据
- **Logic**：炉号解析、规格识别、物理属性计算、质量判定、统计汇总
- **Action**：导入数据、录入数据、生成报表、导出 Excel
- **Security**：RBAC 权限控制、数据权限限制、审计日志

### 4. AIP 应用
- **自然语言问数**：大模型解析意图，生成结构化查询
- **外观特征匹配**：大模型匹配外观特征大类和子类
- **质量预测**：基于历史数据预测质量等级

---

## 下一步：Palantir Ontology 设计

基于以上需求分析，我们将设计：

1. **Ontology 模型**：定义 Objects、Properties、Links、Actions
2. **用例设计**：焊接协作臂管理、小组立产线排产
3. **架构设计**：基于 Foundry 的系统架构
4. **实施路径**：从原型到生产的实施计划
